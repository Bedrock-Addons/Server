!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],t):e.Filepicker=t(e.jQuery)}(this,function(e){"use strict";function t(t){t.prototype.fetch=function(e){return this._ajax(this._route("fetch"),e)},t.prototype.update=function(t,i){var n=this._route("patch","PATCH");return this._ajax(n,e.extend({},{file:t},i||{}))},t.prototype["delete"]=function(t){return t=e.isArray(t)?t:[t],this._ajax(this._route("delete","DELETE"),{files:t})},t.prototype.trans=function(t){var i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=this.options.messages[t]||t.toString();if(e.isFunction(n))n=n.apply(this,[i]);else for(var o in i)n=n.replace(":"+o,i[o]);return n},t.prototype.addProps=function(e){e.extension||(e.extension=this._getExtension(e.name)),e.sizeFormatted=this._formatSize(e.size),e.imageFile=this.options.imageFileTypes.test(e.name),e.timeFormatted=e.time?this._formatTime(e.time):"",e.timeISOString=function(){return Date.prototype.toISOString?new Date(1e3*e.time).toISOString():""}},t.prototype.data=function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],i=this.options.data;return e.isFunction(i)&&(i=i.apply(this)),e.extend({},i,t)},t.prototype.destroy=function(){this.events=[],this.element&&this.element.off("."+t.pluginName),this.options.fileInput&&this.options.fileInput.off("change"),this.options.dropZone&&this.options.dropZone.off("dragover dragenter dragleave drop")},t.prototype.extend=function(t,i){t.$f=this,e.extend(!0,this.options,i)}}function i(t){t.prototype._init=function(t){this.events={},this.plugins={},this.element=t.el||null,this.options=e.extend(!0,e.extend(!0,{},p),t),this._queue=[],this._sending=0,this._registerPlugins(),e.extend(!0,this.options,t),this.options.fileInput instanceof e?this.on(this.options.fileInput,"change",this.onChange):this.on(this.element,"change",this.options.fileInput,this.onChange),this.trigger("init"),this._initPlugins()},t.prototype._registerPlugins=function(){var i=this;e.each(this.options.plugins,function(e,n){t.plugins[n]&&(i.plugins[n]=new t.plugins[n](i))})},t.prototype._initPlugins=function(){var t=this;e.each(this.options.plugins,function(e,i){t.plugins[i]&&t._initPlugin(t.plugins[i])})},t.prototype._initPlugin=function(t){var i=this;t.trigger=function(e,t){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],o=arguments[3];return i.trigger(e,t,n,o)},t.on=function(){var t=arguments;return e.isFunction(t[2])?(t[4]=t[3]||this,t[3]=t[2],t[2]=null):t[4]=t[4]||this,i.on(t[0],t[1],t[2],t[3],t[4])},t.init()}}function n(t){t.prototype._addMethods=function(t){var i=this,n=e.Deferred();return t.state="pending",t.progress={total:0,loaded:0},t.promise=function(){return n.promise()},t.send=function(o){if("sending"===t.state)return n;t.state="sending";var r=t.xhr=e.ajaxSettings.xhr(),s=i._route("upload","POST");r.open(s.method,s.uri,!0),r.upload.onprogress=function(e){e.lengthComputable&&(t.progress.total=e.total,t.progress.loaded=e.loaded,n.notify(e.loaded,e.total,r))},r.onload=function(){r.responseJSON=null;try{r.responseJSON=e.parseJSON(r.responseText)}catch(t){var o=i._getPostMaxSize(r.responseText);o>-1?n.reject(i.trans("postMaxSize",{max:o}),r):n.reject(i.trans("error"),r)}null!=r.responseJSON&&(200===r.status||201===r.status?n.resolve(r.responseJSON,r):n.reject(i.trans("error",{response:r.responseJSON}),r))};var a=new FormData;return e.each(i.data(o),function(e,t){a.append(e,t)}),e.each(t.files,function(e,t){t.error||a.append(i.options.paramName,t,t.name)}),r.send(a),t.promise()},t.abort=function(){t.xhr&&t.xhr.abort(),i._processQueue()},t},t.prototype._processQueue=function(){this._sending--;var e=this.options.parallelUploads;if(!e||e>this._sending)for(var t=0;t<this._queue.length;t++)if("sending"!=this._queue[t].state){this._queue[t].send(),this._queue.splice(t,1),this._sending++;break}},t.prototype._ajax=function(t,i){return"GET"!=t.method&&"POST"!=t.method&&(i._method=t.method,t.method="POST"),e.ajax({url:t.uri,type:t.method,dataType:"json",data:this.data(i)})},t.prototype._route=function(e,t){var i=this.options.routes[e];return{uri:i?i.uri:this.options.url,method:i?i.method:t||"GET"}},t.prototype._getExtension=function(e){return e.substr(e.lastIndexOf(".")+1,e.length)},t.prototype._formatTime=function(e){var t=new Date(1e3*e),i=t.getFullYear(),n=("0"+(t.getMonth()+1)).slice(-2),o=("0"+t.getDate()).slice(-2),r=t.getHours(),s=r,a=("0"+t.getMinutes()).slice(-2),p="AM";return r>12?(s=r-12,p="PM"):12===r?(s=12,p="PM"):0==r&&(s=12),i+"-"+n+"-"+o+", "+s+":"+a+" "+p},t.prototype._formatSize=function(t){if(!e.isNumeric(t))return"";var i={GB:1073741824,MB:1048576,KB:1024,B:1};for(var n in i)if(t>=i[n]){var o=Math.round(t/i[n]*10)/10;return o+" "+n}},t.prototype._getInputFiles=function(t){var i=e.makeArray(t.prop("files"));return this._replaceInput(t),i},t.prototype._replaceInput=function(t){var i=t.clone(!0);e("<form/>").append(i)[0].reset(),t.after(i).detach(),e.cleanData(t.off("remove"));var n=[];this.options.fileInput instanceof e?n=this.options.fileInput:this.element&&(n=this.element.find(this.options.fileInput)),n.map(function(e,n){return n===t[0]?i[0]:n})},t.prototype._getPostMaxSize=function(e){if(-1===e.indexOf("POST Content-Length"))return-1;var t=e.match(/\d+/g)||[];return t[1]?Math.round(t[1]/1048576):0}}function o(t){e.fn[t.pluginName]=function(){var i=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=e(this),o=n.data(t.pluginName);return o?o:this.each(function(){i.el=e(this),i.el.data(t.pluginName,new t(i))})}}function r(t){function i(e){var t=e.originalEvent;if(t)for(var i in t)i in e||(e[i]=t[i])}t.prototype.on=function(){if(!arguments[0])return!1;if(arguments[0]instanceof e){var t=arguments[0],i=arguments[1],n=arguments[2],o=arguments[3],r=arguments[4];e.isFunction(n)&&(r=o,o=n,n=null),t.on(i,n,e.proxy(o,r||this))}else{var s=arguments[0],a=arguments[1];(this.events[s]=this.events[s]||[]).push(a)}},t.prototype.off=function(e,t){this.element&&this.element.off(e,t),e||(this.events={});for(var i=this.events[e]||[],n=i.length=t?i.length:0;n--;)t==i[n]&&i.splice(n,1)},t.prototype.trigger=function(n,o){var r=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],s=arguments[3];o=e.Event(o),o.type=n+"."+t.namespace,s=s||this,this.element&&(o.target=this.element[0]),i(o),this.element&&this.element.trigger(o,r),this._emit.apply(this,[n,s,o].concat(r));var a=e.isFunction(this.options[n])&&this.options[n].apply(s,[o].concat(r))===!1;return!(a||o.isDefaultPrevented())},t.prototype._emit=function(e,t){for(var i=this.events[e]||[],n=0,o=void 0;o=i[n++];)o.apply(t||this,[].slice.call(arguments,2))}}function s(t){t.prototype.onChange=function(t){return window.File&&window.FileList&&window.FormData?void this.onAdd(t,{files:this._getInputFiles(e(t.target))}):this.trigger("uploadfallback",t,this.trans("uploadFallback"))},t.prototype.onAdd=function(t,i){var n=this,o=0,r=0,s=[],a=this.options.uploadMultipleLimit,p=this.options.uploadMultipleSize,l=this.options.uploadMultipleSizeOverhead,u=function(e){return n.trigger("validate",t,e)};if(e.each(i.files,function(e,t){return n.addProps(t)}),i.originalFiles=i.files,this.options.uploadMultiple)if(a)for(o=0;o<i.files.length;o+=a){var h=i.files.slice(o,o+a);e.each(h,function(e,t){u(t)}),s.push(h)}else e.each(i.files,function(e,t){u(t)||(r+=t.size+l,p&&r>p&&(o++,r=t.size+l)),s[o]||(s[o]=[]),s[o].push(t)});else e.each(i.files,function(e,t){u(t),s.push([t])});e.each(s,function(o,r){var s=e.extend({},i,{files:r});n._addMethods(s),n.trigger("add",t,s)})},t.prototype.onSend=function(e,t){var i=this,n=t.files.filter(function(e){return!e.error});if(0==n.length)return!1;if(this.trigger("send",e,t)===!1)return this.onFail(this.trans(t.errorThrown||"abort"),t);t.promise().progress(function(e,n){return i.onProgress(e,n,t)}).done(function(e,n){return i.onDone(n.responseJSON,t)}).fail(function(e){return i.onFail(e,t)}).always(function(e){return i.onAlways(e,t)});var o=this.options.parallelUploads;!o||o>this._sending?(this._sending++,t.send()):this._queue.push(t)},t.prototype.onProgress=function(e,t,i){i.progress.percentage=Math.floor(e/t*100),this.trigger("progress",null,i)},t.prototype.onDone=function(t,i){i.result=t,i.state="sent";for(var n=0;n<i.files.length;n++)i.files[n]=e.extend({original:i.files[n]},t[n]),this.addProps(i.files[n]);this.trigger("done",null,i)},t.prototype.onFail=function(e,t){t.errorThrown=e,t.state="failed",this.trigger("fail",null,t)},t.prototype.onAlways=function(e,t){this._processQueue(),t.resultOrError=e,this.trigger("always",null,t)}}function a(e){this._init(e)}e="default"in e?e["default"]:e;var p={routes:{},plugins:[],uploadMultiple:!1,uploadMultipleLimit:void 0,uploadMultipleSize:void 0,uploadMultipleSizeOverhead:512,parallelUploads:void 0,imageFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,minFileSize:1,data:{},paramName:"files[]",fileInput:'input[type="file"]',messages:{uploadFallback:"The browser does not support file uploads.",minFileSize:"The file must be at least :min KB.",maxFileSize:"The file may not be greater than :max KB.",postMaxSize:"The file exceeds the post max size limit of :max MB.",invalidFileType:"The file type is not allowed.",error:"Oops! Something went wrong.",abort:"The operation was aborted."},add:function(e,t){e.isDefaultPrevented()||this.onSend(e,t)},validate:function(e,t){var i=this.options;return i.acceptFileTypes&&!i.acceptFileTypes.test(t.name)?t.error=this.trans("invalidFileType"):void 0!==t.size&&i.maxFileSize&&t.size>i.maxFileSize?t.error=this.trans("maxFileSize",{max:i.maxFileSize/1e3}):void 0!==t.size&&i.minFileSize&&t.size<i.minFileSize&&(t.error=this.trans("minFileSize",{min:i.minFileSize/1e3})),void 0===t.error},uploadfallback:function(e,t){alert(t)}};return a.plugins={},a.namespace="filepicker",a.pluginName="filePicker",a.plugin=function(e,t){a.plugins[e]=t},i(a),s(a),r(a),n(a),t(a),o(a),a});