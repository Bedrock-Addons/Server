!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("jquery"),require("filepicker")):"function"==typeof define&&define.amd?define(["jquery","filepicker"],t):t(e.jQuery,e.Filepicker)}(this,function(e,t){"use strict";function i(e){e.extend(this,o)}e="default"in e?e["default"]:e,t="default"in t?t["default"]:t;var n=function r(e,t){var i=/[^\w\-\.:]/.test(e)?new Function(r.arg+",tmpl","var _e=tmpl.encode"+r.helper+",_s='"+e.replace(r.regexp,r.func)+"';return _s;"):r.cache[e]=r.cache[e]||r(r.load(e));return t?i(t,r):function(e){return i(e,r)}};n.cache={},n.load=function(e){return document.getElementById(e).innerHTML},n.regexp=/([\s'\\])(?!(?:[^{]|\{(?!%))*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g,n.func=function(e,t,i,n,o,r){return t?{"\n":"\\n","\r":"\\r","	":"\\t"," ":" "}[t]||"\\"+t:i?"="===i?"'+_e("+n+")+'":"'+("+n+"==null?'':"+n+")+'":o?"';":r?"_s+='":void 0},n.encReg=/[<>&"'\x00]/g,n.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"},n.encode=function(e){return(null==e?"":""+e).replace(n.encReg,function(e){return n.encMap[e]||""})},n.arg="o",n.helper=",print=function(s,e){_s+=e?(s==null?'':s):_e(s);},include=function(s,d){_s+=tmpl(s,d);}";var o={ui:{autoLoad:!0,autoUpload:!0,perPage:15,refreshPagination:!1,prependFiles:!0,previewThumbnailSize:[64,64],timeago:!1,selectors:{filesList:".files",preview:".preview",progress:".progress-bar",error:".error",start:".start",cancel:".cancel","delete":".delete",startAll:".start-all",cancelAll:".cancel-all",deleteAll:".delete-all",pagination:".pagination-container"},uploadTemplateId:"uploadTemplate",downloadTemplateId:"downloadTemplate",paginationTemplateId:"paginationTemplate"},messages:{processing:"Processing...",deleteFail:"Could not delete file :file."},add:function(e,t){return e.isDefaultPrevented()?!1:(this.trigger("renderupload",e,t),void((this.options.ui.autoUpload||t.autoUpload)&&this.onSend(e,t)))},progress:function(t,i){var n=this;return t.isDefaultPrevented()?!1:void e.each(i.files,function(e,t){var o=i.progress.percentage;t.context.find(n.options.ui.selectors.progress).text(100===o?n.trans("processing"):o+"%").css("width",o+"%")})},done:function(e,t){return e.isDefaultPrevented()?!1:void this.trigger("renderdownload",e,t)},fail:function(t,i){var n=this;if(t.isDefaultPrevented())return!1;var o=this.options.ui.selectors;e.each(i.files,function(e,t){t.context.find(o.error).text(n.trans(i.errorThrown)),t.context.find(o.progress).text("").css("width","0%"),t.context.find(o.start).prop("disabled",!1)})},always:function(t,i){var n=this;e.each(i.files,function(e,t){t.context.find(n.options.ui.selectors.progress).parent().hide()}),0==this._sending&&this.options.ui.refreshPagination&&this.plugins.ui.fetchFiles()},load:function(e,t){return e.isDefaultPrevented()?!1:void this.trigger("renderdownload",e,t)},start:function(t,i){var n=this;t.isDefaultPrevented()?e.each(i.files,function(e,t){t.context.find(n.options.ui.selectors.start).prop("disabled",!1)}):this.onSend(t,i)},cancel:function(t,i){return t.isDefaultPrevented()?!1:void e.each(i.files,function(e,t){return t.context.remove()})},renderupload:function(t,i){var n=this;e.each(i.files,function(e,t){t.autoUpload=n.options.ui.autoUpload,t.context=n.plugins.ui.renderTemplate(n.options.ui.uploadTemplateId,{file:t}),t.context.data("data",i),t.imageFile&&n.plugins.ui.renderThumbnailPreview(t);var o=n.options.ui.prependFiles?"prepend":"append";n.options.ui.filesList[o](t.context),t.context.addClass("in")}),this.trigger("renderdone",t,i)},renderdownload:function(t,i){var n=this;e.each(i.files,function(e,t){n.addProps(t),t.context=n.plugins.ui.renderTemplate(n.options.ui.downloadTemplateId,{file:t}),t.context.find(n.options.ui.selectors["delete"]).data("filename",t.name),t.original?(t.original.context.removeClass("in"),t.original.context.replaceWith(t.context),t.context.data("data",i)):n.options.ui.filesList.append(t.context),t.context.addClass("in")}),this.trigger("renderdone",t,i)},renderdone:function(t,i){this.options.ui.timeago&&e.fn.timeago&&e.each(i.files,function(e,t){t.context.find("time").timeago()})},renderpagination:function(e,t){this.options.filesList.children().remove(),this.options.pagination.html(this.renderTemplate(this.options.paginationTemplateId,t))},"delete":function(e,t){var i=this;return e.isDefaultPrevented()?!1:void this["delete"](t.filename).done(function(n,o,r){return i.trigger("deletedone",e,[t,r])}).fail(function(n){return i.trigger("deletefail",e,[t,n])}).always(function(n){return i.trigger("deletealways",e,[t,n])})},deletedone:function(e,t,i){return e.isDefaultPrevented()?!1:i.responseJSON[t.filename]!==!0?this.trigger("deletefail",e,[t,i]):(t.context&&t.context.remove(),void(this.options.ui.pagination&&0==this.options.ui.filesList.children().length&&this.plugins.ui.fetchFiles(-1)))},deletefail:function(e,t){return e.isDefaultPrevented()?!1:void alert(this.trans("deleteFail",{file:t.filename}))},startall:function(e){return e.isDefaultPrevented()?!1:void this.options.ui.filesList.find(this.options.ui.selectors.start).trigger("click")},cancelall:function(e){return e.isDefaultPrevented()?!1:void this.options.ui.filesList.find(this.options.ui.selectors.cancel).trigger("click")},deleteall:function(e){return e.isDefaultPrevented()?!1:void this.options.ui.filesList.find(this.options.ui.selectors["delete"]).trigger("click")}};i.prototype.init=function(){var e=this;this.options=this.$f.options.ui;var t=this.options,i=this.$f.element,n=this.options.selectors;t.filesList||(t.filesList=i.find(n.filesList)),t.pagination||(t.pagination=i.find(n.pagination)),this.on(t.filesList,"click",n.start,this.onStart),this.on(t.filesList,"click",n.cancel,this.onCancel),this.on(t.filesList,"click",n["delete"],this.onDelete),this.on(t.startAll||i,"click",t.startAll?null:n.startAll,this.onStartAll),this.on(t.cancelAll||i,"click",t.cancelAll?null:n.cancelAll,this.onCancelAll),this.on(t.deleteAll||i,"click",t.deleteAll?null:n.deleteAll,this.onDeleteAll),this._currentPage=1,t.autoLoad&&(t.perPage?(this.on(this.options.pagination,"click","a",this.onPageClick),this.fetchFiles()):this.$f.fetch().done(function(t){e.$f.trigger("load",null,t)}))},i.prototype.onPageClick=function(t){t.preventDefault();var i=parseInt(e(t.target).data("page"));i&&this.fetchFiles(i)},i.prototype.fetchFiles=function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?1:arguments[0];this._currentPage=-1==t?this._currentPage-1:t,this._currentPage<1&&(this._currentPage=1);var i={limit:this.options.perPage,offset:this._currentPage*this.options.perPage-this.options.perPage};this.$f.fetch(i).done(function(t){e.renderPagination(t)})},i.prototype.renderPagination=function(e){var t=0,i=0,n=1,o=this._currentPage,r=Math.ceil(e.total/this.options.perPage),a=o>1?o-1:null,l=r>o?o+1:null;2*n>=o?(t=1,i=Math.min(1+2*n,r)):o>r-2*n?(t=r-2*n,i=r):(t=o-n,i=o+n);var s={total:e.total,currentPage:o,prevPage:a,nextPage:l,lastPage:r,firstAdjacentPage:t,lastAdjacentPage:i};this.$f.trigger("renderpagination",null,s,this),this.$f.trigger("load",null,e)},i.prototype.onStart=function(t){t.preventDefault();var i=e(t.currentTarget),n=i.closest(".upload-template"),o=n.data("data");i.prop("disabled",!0),o&&o.send&&this.$f.trigger("start",t,o)},i.prototype.onCancel=function(t){t.preventDefault();var i=e(t.currentTarget).closest(".upload-template,.download-template"),n=i.data("data")||{};n.abort&&n.abort(),this.$f.trigger("cancel",t,n)},i.prototype.onDelete=function(t){t.preventDefault();var i=e(t.currentTarget);this.$f.trigger("delete",t,{filename:i.data("filename"),context:i.closest(".download-template")})},i.prototype.onStartAll=function(e){e.preventDefault(),this.$f.trigger("startall",e)},i.prototype.onCancelAll=function(e){e.preventDefault(),this.$f.trigger("cancelall",e)},i.prototype.onDeleteAll=function(e){e.preventDefault(),this.$f.trigger("deleteall",e)},i.prototype.renderTemplate=function(t,i){return e(n(t,i))},i.prototype.renderThumbnailPreview=function(e){var t=this,i=document.createElement("canvas"),n=i.getContext("2d"),o=new Image;i.width=this.options.previewThumbnailSize[0],i.height=this.options.previewThumbnailSize[1],o.onload=function(){n.drawImage(o,0,0,80,80*o.height/o.width),e.context.find(t.options.selectors.preview).html(i)},o.src=window.URL.createObjectURL(e)},t.plugin("ui",i)});